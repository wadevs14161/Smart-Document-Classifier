{% extends "base.html" %}

{% block title %}Smart Document Classifier - Main Interface{% endblock %}

{% block content %}
<div class="upload-area">
    <h3>üìÅ Upload Document</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">
        Supported formats: TXT, PDF, DOCX files
    </p>
    <input type="file" id="fileInput" accept=".txt,.pdf,.docx" style="margin: 15px; padding: 10px; font-size: 16px;">
    <br>
    <button class="btn" onclick="uploadFile()" id="uploadBtn">
        üì§ Upload & Classify
    </button>
    <div style="margin-top: 15px;">
        <label style="font-size: 14px; color: #6c757d;">
            <input type="checkbox" id="autoClassify" checked style="margin-right: 8px;"> 
            Auto-classify on upload
        </label>
    </div>
</div>

<div id="result"></div>

<div style="background: white; padding: 25px; border-radius: 10px; margin-top: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">üìö Uploaded Documents</h3>
        <button class="btn btn-secondary" onclick="loadDocuments()" id="refreshBtn">
            üîÑ Refresh
        </button>
    </div>
    <p style="color: #6c757d; margin-bottom: 20px;">
        Newest documents appear first ‚Ä¢ Click to expand document details
    </p>
    <div id="documents"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    console.log('Smart Document Classifier UI loaded');
    
    let isProcessing = false;

    function uploadFile() {
        console.log('=== UPLOAD FUNCTION CALLED ===');
        
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        const uploadBtn = document.getElementById('uploadBtn');
        
        console.log('File input:', fileInput);
        console.log('File selected:', file);
        console.log('Upload button:', uploadBtn);
        
        if (!file) {
            showAlert('Please select a file first!', 'error');
            return;
        }
        
        if (isProcessing) {
            console.log('Already processing...');
            return;
        }
        
        // Show processing state
        isProcessing = true;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="loading-spinner"></span>Processing...';
        
        const formData = new FormData();
        formData.append('file', file);
        
        console.log('Uploading file:', file.name);
        
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            console.log('Upload result:', result);
            
            let html = `
                <div class="alert alert-success">
                    <h4 style="margin: 0 0 10px 0;">‚úÖ Upload Successful!</h4>
                    <strong>üìÑ File:</strong> ${result.filename}<br>
                    <strong>üÜî Document ID:</strong> ${result.document_id}<br>
                    <strong>üìè Size:</strong> ${(result.file_size / 1024).toFixed(1)} KB
                </div>
            `;
            
            if (result.classification) {
                const confidence = (result.classification.confidence_score * 100).toFixed(1);
                html += `
                    <div class="alert alert-info">
                        <h4 style="margin: 0 0 10px 0;">ü§ñ Auto-Classification Result</h4>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div>
                                <strong>üìÇ Category:</strong> ${result.classification.predicted_category}<br>
                                <strong>üìä Confidence:</strong> ${confidence}%
                            </div>
                            <div class="confidence-bar" style="width: 200px;">
                                <div class="confidence-fill" style="width: ${confidence}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('result').innerHTML = html;
            fileInput.value = '';
            
            // Auto-refresh documents list
            setTimeout(() => loadDocuments(), 500);
        })
        .catch(error => {
            console.error('Upload error:', error);
            showAlert(`Upload failed: ${error.message}`, 'error');
        })
        .finally(() => {
            // Reset processing state
            isProcessing = false;
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = 'üì§ Upload & Classify';
        });
    }
    
    function loadDocuments() {
        console.log('Loading documents...');
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.innerHTML = '<span class="loading-spinner"></span>Loading...';
        
        fetch('/documents')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(documents => {
            console.log('Documents loaded:', documents.length);
            
            const documentsDiv = document.getElementById('documents');
            
            if (documents.length === 0) {
                documentsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h4>üìù No documents uploaded yet</h4>
                        <p>Upload your first document using the form above!</p>
                    </div>
                `;
                return;
            }
            
            documentsDiv.innerHTML = documents.map(doc => {
                const uploadDate = new Date(doc.uploaded_at).toLocaleString();
                const updateDate = doc.updated_at ? new Date(doc.updated_at).toLocaleString() : null;
                const classificationTime = doc.classification_time ? new Date(doc.classification_time).toLocaleString() : null;
                const inferenceTime = doc.inference_time ? `${doc.inference_time.toFixed(3)}s` : 'N/A';
                
                const hasContent = doc.content_text && doc.content_text.trim().length > 0;
                const confidence = doc.confidence_score ? (doc.confidence_score * 100).toFixed(1) + '%' : 'N/A';
                
                let statusHtml = '';
                if (doc.is_classified) {
                    statusHtml = `
                        <div style="margin: 15px 0;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                <span class="classification-status classified">‚úÖ ${doc.predicted_category}</span>
                                <div class="confidence-bar" style="width: 200px;">
                                    <div class="confidence-fill" style="width: ${doc.confidence_score * 100}%"></div>
                                </div>
                                <span style="font-weight: bold;">${confidence}</span>
                            </div>
                            <div class="metadata">
                                ‚è±Ô∏è <strong>Inference Time:</strong> ${inferenceTime}
                            </div>
                        </div>
                    `;
                } else {
                    statusHtml = `
                        <div style="margin: 15px 0;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span class="classification-status not-classified">‚è≥ Not classified</span> 
                                <button class="btn" onclick="classifyDocument(${doc.id})" id="classify-btn-${doc.id}">
                                    üîç Classify Now
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="doc-item" id="doc-${doc.id}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <strong style="font-size: 1.2em;">üìÑ ${doc.original_filename}</strong>
                                    <span style="background: #e9ecef; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold;">
                                        ${doc.file_type ? doc.file_type.toUpperCase() : 'UNKNOWN'}
                                    </span>
                                </div>
                                
                                <div class="metadata">
                                    üìè <strong>Size:</strong> ${(doc.file_size / 1024).toFixed(1)} KB | 
                                    üìÖ <strong>Uploaded:</strong> ${uploadDate}
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="deleteDocument(${doc.id})" style="font-size: 0.8em; padding: 6px 12px;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                        
                        ${statusHtml}
                        
                        ${hasContent ? `
                            <div style="margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="toggleContent(${doc.id})" 
                                        style="font-size: 0.9em;" id="toggle-btn-${doc.id}">
                                    üìñ Show Content
                                </button>
                                <div id="content-${doc.id}" style="display: none;" class="content-section">
                                    <h5 style="margin: 0 0 15px 0; color: #495057;">üìÑ Document Content:</h5>
                                    <div class="content-text">
                                        ${doc.content_text || 'No content available'}
                                    </div>
                                    <div style="margin-top: 10px; font-size: 0.8em; color: #6c757d;">
                                        üìä Character count: ${doc.content_text ? doc.content_text.length.toLocaleString() : 0}
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <span style="color: #856404;">‚ö†Ô∏è No content available for this document</span>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Error loading documents:', error);
            document.getElementById('documents').innerHTML = 
                '<div class="alert alert-error">‚ùå Error loading documents: ' + error.message + '</div>';
        })
        .finally(() => {
            refreshBtn.innerHTML = 'üîÑ Refresh';
        });
    }
    
    function toggleContent(docId) {
        const contentDiv = document.getElementById(`content-${docId}`);
        const toggleBtn = document.getElementById(`toggle-btn-${docId}`);
        
        if (contentDiv.style.display === 'none') {
            contentDiv.style.display = 'block';
            toggleBtn.innerHTML = 'üìñ Hide Content';
            toggleBtn.className = 'btn btn-danger';
            
            // Smooth animation
            contentDiv.style.opacity = '0';
            contentDiv.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                contentDiv.style.transition = 'all 0.3s ease';
                contentDiv.style.opacity = '1';
                contentDiv.style.transform = 'translateY(0)';
            }, 10);
        } else {
            contentDiv.style.display = 'none';
            toggleBtn.innerHTML = 'üìñ Show Content';
            toggleBtn.className = 'btn btn-secondary';
        }
    }
    
    async function classifyDocument(docId) {
        const button = document.getElementById(`classify-btn-${docId}`);
        const docElement = document.getElementById(`doc-${docId}`);
        
        if (!button || isProcessing) return;
        
        // Show processing state
        isProcessing = true;
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span>Classifying...';
        docElement.classList.add('pulse');
        
        try {
            const response = await fetch(`/documents/${docId}/classify`, {
                method: 'POST'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // Success animation
            docElement.style.background = '#d4edda';
            setTimeout(() => {
                docElement.style.background = 'white';
            }, 1000);
            
            // Show success message
            const resultData = result.classification_result;
            const confidence = (resultData.confidence_score * 100).toFixed(1);
            
            showAlert(`üéâ Classification successful!\\n\\nüìÇ Category: ${resultData.predicted_category}\\nüìä Confidence: ${confidence}%\\n‚è±Ô∏è Inference Time: ${resultData.inference_time}s`, 'success');
            
            // Refresh the documents list
            setTimeout(() => loadDocuments(), 500);
            
        } catch (error) {
            // Error state
            docElement.style.background = '#f8d7da';
            setTimeout(() => {
                docElement.style.background = 'white';
            }, 2000);
            
            showAlert(`‚ùå Classification failed: ${error.message}`, 'error');
            
            // Reset button state
            button.disabled = false;
            button.innerHTML = 'üîç Classify Now';
        } finally {
            // Remove processing state
            isProcessing = false;
            docElement.classList.remove('pulse');
        }
    }
    
    async function deleteDocument(docId) {
        if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/documents/${docId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            showAlert(`‚úÖ ${result.message}`, 'success');
            
            // Remove the document element with animation
            const docElement = document.getElementById(`doc-${docId}`);
            docElement.style.transition = 'all 0.3s ease';
            docElement.style.transform = 'translateX(-100%)';
            docElement.style.opacity = '0';
            
            setTimeout(() => {
                loadDocuments();
            }, 300);
            
        } catch (error) {
            showAlert(`‚ùå Delete failed: ${error.message}`, 'error');
        }
    }
    
    function showAlert(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-error' : 'alert-info';
        
        const html = `<div class="alert ${alertClass}">${message}</div>`;
        document.getElementById('result').innerHTML = html;
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            const resultDiv = document.getElementById('result');
            if (resultDiv.innerHTML.includes(message)) {
                resultDiv.innerHTML = '';
            }
        }, 5000);
    }
    
    // Load documents on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, loading documents...');
        loadDocuments();
    });
    
    // Auto-refresh every 30 seconds
    setInterval(loadDocuments, 30000);
    
    console.log('JavaScript loaded successfully!');
</script>
{% endblock %}
